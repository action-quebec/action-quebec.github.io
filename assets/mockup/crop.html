<!doctype html>
<meta charset="utf-8">
<title>DnD + Crop + Upload (Catbox)</title>
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.css">
<style>
  body { font: 16px/1.4 system-ui, sans-serif; margin: 2rem; }
  .drop { border: 2px dashed #999; padding: 2rem; text-align: center; border-radius: 12px; }
  .drop.drag { border-color: #333; }
  img { max-width: 100%; display: block; margin-top: 1rem; }
  .row { display:flex; gap:.75rem; margin-top:1rem; flex-wrap: wrap; }
  button { padding:.6rem 1rem; border:1px solid #ccc; border-radius:10px; background:#f7f7f7; cursor:pointer; }
  input[type="text"] { width:100%; padding:.6rem; }
</style>
<div class="drop" id="drop">Glissez une image ici ou cliquez pour choisir</div>
<input id="file" type="file" accept="image/*" hidden>
<img id="preview" alt="Aperçu">
<div class="row">
  <button id="btnCatbox">Recadrer & uploader → Catbox</button>
  <button id="btnLitter">Recadrer & uploader → Litterbox (24h)</button>
</div>
<input id="out" type="text" placeholder="URL retournée…" readonly>

<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.js"></script>
<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('file');
const img = document.getElementById('preview');
const out = document.getElementById('out');
let cropper;

function loadFile(file){
  const url = URL.createObjectURL(file);
  img.onload = () => URL.revokeObjectURL(url);
  img.src = url;
  if (cropper) cropper.destroy();
  cropper = new Cropper(img, { viewMode:1, dragMode:'move', autoCropArea:1, background:false });
}

drop.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => e.target.files[0] && loadFile(e.target.files[0]));

;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e=>{
  e.preventDefault(); e.dataTransfer.dropEffect='copy'; drop.classList.add('drag');
}));
;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e=>{
  e.preventDefault(); drop.classList.remove('drag');
}));
drop.addEventListener('drop', e => {
  const f = e.dataTransfer.files?.[0];
  if (f && f.type.startsWith('image/')) loadFile(f);
});

async function cropToBlob(type='image/jpeg', quality=0.92){
  if(!cropper) throw new Error('Aucune image chargée');
  return new Promise(r => cropper.getCroppedCanvas().toBlob(r, type, quality));
}

async function uploadTo(path, extra = {}) {
  const blob = await cropToBlob();
  const fd = new FormData();
  for (const [k,v] of Object.entries(extra)) fd.append(k, v);
  fd.append('fileToUpload', new File([blob], 'crop.jpg', {type: blob.type}));
  const res = await fetch(path, { method:'POST', body: fd });
  if(!res.ok) throw new Error('Upload échoué');
  const txt = (await res.text()).trim();
  out.value = txt; // Catbox/Litterbox renvoient juste l’URL en texte brut
}

document.getElementById('btnCatbox').onclick = () =>
  uploadTo('/api/catbox', { reqtype:'fileupload' /*, userhash:'OPTIONNEL' */ })
  .catch(err => alert(err.message));

document.getElementById('btnLitter').onclick = () =>
  uploadTo('/api/litterbox', { reqtype:'fileupload', time:'24h' })
  .catch(err => alert(err.message));
</script>
