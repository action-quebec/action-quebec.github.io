<!doctype html>
<meta charset="utf-8" />
<title>Test — Crop 5/4 + Upload Catbox (via Cloudflare Worker)</title>
<style>
  :root { --ratio-w: 5; --ratio-h: 4; }
  body { font: 16px/1.4 system-ui, sans-serif; margin: 2rem; color:#111; }
  h1 { font-size: 1.25rem; margin: 0 0 1rem; }
  .drop {
    border: 2px dashed #bbb; border-radius: 12px; padding: 1.25rem; text-align: center;
    transition: border-color .2s ease; cursor: pointer; user-select: none;
  }
  .drop.drag { border-color: #333; }
  .frame {
    width: 640px; /* taille d’édition (modifie comme tu veux) */
    aspect-ratio: var(--ratio-w) / var(--ratio-h);
    border: 2px solid #ddd; border-radius: 12px;
    position: relative; overflow: hidden; margin: 1rem 0; background:
      conic-gradient(#eee 25%, #e7e7e7 0 50%, #eee 0 75%, #e7e7e7 0) 0 0 / 16px 16px;
  }
  .frame img {
    position: absolute; top:0; left:0; transform-origin: top left; will-change: transform; pointer-events: none;
  }
  .row { display:flex; gap:.75rem; flex-wrap: wrap; align-items: center; margin: .5rem 0; }
  button, select, input { padding:.55rem .8rem; border:1px solid #ccc; border-radius:10px; background:#f8f8f8; }
  input[type="number"] { width:7rem; }
  .muted { color:#666; font-size:.9rem; }
  .result { display:none; align-items:center; gap:.75rem; margin-top:.75rem; }
  .result a { text-decoration: none; }
  .preview { max-width: 320px; border:1px solid #ddd; border-radius:8px; }
  .spinner { display:none; width:16px; height:16px; border:2px solid #aaa; border-top-color:transparent; border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to { transform: rotate(1turn); } }
</style>

<h1>Test — recadrage 5/4 et upload Catbox</h1>

<div class="drop" id="drop">Glissez une image ici ou cliquez pour choisir</div>
<input id="file" type="file" accept="image/*" hidden>

<div class="frame" id="frame">
  <img id="img" alt="">
</div>

<div class="row">
  <label>Largeur export (px)
    <input type="number" id="outW" value="2000" min="200" step="100">
  </label>
  <label>Format
    <select id="fmt">
      <option value="image/jpeg">JPEG</option>
      <option value="image/png">PNG</option>
    </select>
  </label>
  <output id="zoomInfo" class="muted">zoom: 1.00×</output>
</div>

<div class="row">
  <button id="btnReset">Réinitialiser</button>
  <button id="btnExport">Exporter localement</button>
  <button id="btnUpload">Exporter & envoyer → Catbox</button>
  <span class="spinner" id="spin"></span>
</div>

<div class="row result" id="resultRow">
  <strong>URL Catbox:</strong>
  <input id="url" type="text" readonly style="width:420px;"/>
  <button id="btnCopy">Copier</button>
  <a id="openUrl" target="_blank" rel="noopener">Ouvrir</a>
</div>

<div class="row" id="localRow" style="display:none">
  <a id="dl" download="crop.jpg">Télécharger l’image exportée</a>
  <img id="preview" class="preview">
</div>

<p class="muted">Astuce: molette pour zoomer (au pointeur), drag pour déplacer. Le cadre (bord gris) est le recadrage <strong>5/4</strong>.</p>

<script>
const PROXY_BASE = 'https://catbox-proxy.action-quebec.workers.dev'; // ← ton Worker
                          //catbox-proxy.action-quebec.workers.dev

// --- DOM
const drop = document.getElementById('drop');
const fileInput = document.getElementById('file');
const frame = document.getElementById('frame');
const img = document.getElementById('img');
const outWInp = document.getElementById('outW');
const fmtSel = document.getElementById('fmt');
const zoomInfo = document.getElementById('zoomInfo');
const btnReset = document.getElementById('btnReset');
const btnExport = document.getElementById('btnExport');
const btnUpload = document.getElementById('btnUpload');
const spin = document.getElementById('spin');
const resRow = document.getElementById('resultRow');
const urlOut = document.getElementById('url');
const btnCopy = document.getElementById('btnCopy');
const openUrl = document.getElementById('openUrl');
const dl = document.getElementById('dl');
const prev = document.getElementById('preview');
const localRow = document.getElementById('localRow');

// --- Ratio fixe 5/4 (modifie ces 2 lignes si besoin)
document.documentElement.style.setProperty('--ratio-w', 5);
document.documentElement.style.setProperty('--ratio-h', 4);

// --- État
let imgW=0, imgH=0, s=1, minS=1, tx=0, ty=0;
let panning=false, startX=0, startY=0, startTx=0, startTy=0;

// Charge un fichier image
function loadFile(file){
  const url = URL.createObjectURL(file);
  img.onload = () => {
    URL.revokeObjectURL(url);
    imgW = img.naturalWidth; imgH = img.naturalHeight;
    fitCover();
  };
  img.src = url;
}

function fitCover() {
  const fw = frame.clientWidth, fh = frame.clientHeight;
  minS = s = Math.max(fw / imgW, fh / imgH);
  tx = (fw - imgW * s) * 0.5;
  ty = (fh - imgH * s) * 0.5;
  apply();
}

function clamp() {
  const fw = frame.clientWidth, fh = frame.clientHeight;
  const w = imgW * s, h = imgH * s;
  tx = Math.min(0, Math.max(fw - w, tx));
  ty = Math.min(0, Math.max(fh - h, ty));
}

function apply() {
  clamp();
  img.style.transform = `translate(${tx}px, ${ty}px) scale(${s})`;
  zoomInfo.value = `zoom: ${(s/minS).toFixed(2)}×`;
}

function zoomAt(deltaY, cx, cy) {
  const prevS = s;
  const zoom = Math.pow(1.0015, -deltaY); // molette douce
  s = Math.max(minS, prevS * zoom);
  // conserver le point sous le curseur
  tx = cx - (s/prevS) * (cx - tx);
  ty = cy - (s/prevS) * (cy - ty);
  apply();
}

// DnD + input
drop.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => e.target.files[0] && loadFile(e.target.files[0]));
;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e=>{
  e.preventDefault(); drop.classList.add('drag'); e.dataTransfer.dropEffect='copy';
}));
;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e=>{
  e.preventDefault(); drop.classList.remove('drag');
}));
drop.addEventListener('drop', e => {
  const f = e.dataTransfer.files?.[0];
  if (f && f.type.startsWith('image/')) loadFile(f);
});

// Interactions
frame.addEventListener('wheel', e => {
  e.preventDefault();
  const r = frame.getBoundingClientRect();
  zoomAt(e.deltaY, e.clientX - r.left, e.clientY - r.top);
}, { passive:false });

frame.addEventListener('pointerdown', e => {
  frame.setPointerCapture(e.pointerId);
  panning = true; startX = e.clientX; startY = e.clientY; startTx = tx; startTy = ty;
});
frame.addEventListener('pointermove', e => {
  if (!panning) return;
  tx = startTx + (e.clientX - startX);
  ty = startTy + (e.clientY - startY);
  apply();
});
frame.addEventListener('pointerup', () => panning=false);
frame.addEventListener('pointercancel', () => panning=false);

btnReset.addEventListener('click', () => img.src && fitCover());

// Calcul du crop → Canvas → Blob
async function exportBlob() {
  if (!img.src) throw new Error('Aucune image chargée');
  const fw = frame.clientWidth, fh = frame.clientHeight;
  const sx = Math.max(0, -tx / s);
  const sy = Math.max(0, -ty / s);
  const sw = Math.min(imgW - sx, fw / s);
  const sh = Math.min(imgH - sy, fh / s);

  const outW = Math.max(50, +outWInp.value|0);
  const ratio = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ratio-w')) /
                parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ratio-h'));
  const outH = Math.round(outW / ratio);

  const cvs = document.createElement('canvas');
  cvs.width = outW; cvs.height = outH;
  const ctx = cvs.getContext('2d', { alpha: fmtSel.value !== 'image/jpeg' });
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img, sx, sy, sw, sh, 0, 0, outW, outH);

  return new Promise(res => cvs.toBlob(res, fmtSel.value, 0.92));
}

// Export local (aperçu + download)
btnExport.addEventListener('click', async () => {
  try {
    const blob = await exportBlob();
    const url = URL.createObjectURL(blob);
    prev.src = url; dl.href = url;
    dl.download = `crop.${fmtSel.value === 'image/png' ? 'png' : 'jpg'}`;
    localRow.style.display = '';
  } catch (err) {
    alert(err.message || err);
  }
});

// Upload Catbox via Worker
btnUpload.addEventListener('click', async () => {
  try {
    spin.style.display = 'inline-block';
    resRow.style.display = 'none';
    const blob = await exportBlob();
    const fd = new FormData();
    fd.append('reqtype', 'fileupload');
    fd.append('fileToUpload', new File([blob], `crop.${fmtSel.value==='image/png'?'png':'jpg'}`, { type: blob.type }));

    const resp = await fetch(`${PROXY_BASE}/api/catbox`, { method: 'POST', body: fd });
    if (!resp.ok) {
      console.log(resp);
      throw new Error('Upload Catbox échoué');
    }
    const text = (await resp.text()).trim(); // Catbox renvoie l’URL en texte brut
    urlOut.value = text; openUrl.href = text;
    resRow.style.display = 'flex';
  } catch (err) {
    alert(err.message || err);
  } finally {
    spin.style.display = 'none';
  }
});

// Copie
btnCopy.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(urlOut.value);
    btnCopy.textContent = 'Copié!';
    setTimeout(() => { btnCopy.textContent = 'Copier'; }, 1000);
  } catch {}
});
</script>
