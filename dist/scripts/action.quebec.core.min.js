(()=>{var v=Object.defineProperty;var w=(t,e,n)=>e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var o=(t,e,n)=>w(t,typeof e!="symbol"?e+"":e,n);self.create=(t,e=null,n=null)=>{let a=document.createElement(t);return e&&(a.className=e),n&&(a.innerHTML=n),a};HTMLElement.prototype.create=function(t,e=null,n=null){let a=create(t,e,n);return this.append(a),a};self.loadJsonProperties=async function(t,e={}){let n=Object.entries(e),a=await Promise.allSettled(n.map(async([s,r])=>{let i=await fetch(r),c=null;try{c=await i.json()}catch{}return{key:s,url:r,status:i.status,ok:i.ok,data:c}}));for(let s of a)if(s.status==="fulfilled"){let{key:r,url:i,status:c,ok:h,data:d}=s.value;if(!h){console.error(`${r} [${c} - ERREUR] ${i}`);continue}t[r]=d}else console.error("Erreur r\xE9seau/JS pendant le chargement :",s.reason);return t};self.escapeForAttr=t=>t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");self.pad=t=>String(t).padStart(2,"0");self.fmtDate=t=>`${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;self.isoLocal=t=>new Date(t).toISOString();self.addDays=(t,e)=>new Date(t.getFullYear(),t.getMonth(),t.getDate()+e);self.inTZ=(t,e="America/Toronto")=>new Date(t).toLocaleDateString("fr-CA",{timeZone:e});self.ymd=t=>new Date(t.getFullYear(),t.getMonth(),t.getDate()).toISOString().slice(0,10);self.startOfWeek=(t,e=0)=>{let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=(n.getDay()-e+7)%7;return n.setDate(n.getDate()-a),n};window.LightSwitch={switch:null,init:function(){let t=localStorage.getItem("theme");t&&document.documentElement.setAttribute("data-theme",t),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>this.setTheme(e.matches?"dark":"light")),document.addEventListener("DOMContentLoaded",e=>document.body.create("div","lightswitch").addEventListener("click",n=>this.toogleTheme())),window.addEventListener("resize",e=>document.documentElement.style.setProperty("--vwpx",String(window.innerWidth)),{passive:!0}),document.documentElement.style.setProperty("--vwpx",String(window.innerWidth))},getTheme:function(){return getComputedStyle(document.documentElement).getPropertyValue("--theme").replace(/^['"]|['"]$/g,"").toLocaleLowerCase().trim()},setTheme:function(t){document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t)},toogleTheme:function(){this.setTheme(this.getTheme()==="dark"?"light":"dark")}};LightSwitch.init();var m=class{constructor(e={}){o(this,"container",null);o(this,"placeholder",null);o(this,"opts",{class:!1,lock:!1,onlyBgClick:!1});this.opts={...this.opts,...e},this.container=document.body.create("div","modal"),this.placeholder=this.container.create("div","modal__placeholder"),this.opts.class&&this.container.classList.add(this.opts.class),this.opts.lock||this.container.addEventListener("click",n=>this.click(n))}async click(e){(!this.opts.onlyBgClick||e.target.classList.contains("modal")||e.target.classList.contains("modal__placeholder"))&&this.hide()}async show(e){switch(typeof e){case"string":this.placeholder.innerHTML=e;break;case"object":this.placeholder.replaceChildren(e);break;case"array":this.placeholder.replaceChildren(...e);break;default:return!1}return this.container.classList.add("show"),!0}async hide(){this.container.classList.remove("show")}};var u=class{constructor(e,n={}){o(this,"MONTH_NAMES",["janvier","f\xE9vrier","mars","avril","mai","juin","juillet","ao\xFBt","septembre","octobre","novembre","d\xE9cembre"]);o(this,"WEEKDAY_NAMES",["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"]);o(this,"parent",null);o(this,"container",null);o(this,"label",null);o(this,"month",null);o(this,"current",null);o(this,"events",null);o(this,"opts",{placeholder:!1,onRenderDate:!1,onClickDate:!1});this.events=new Set,this.current=new Date,this.opts={...this.opts,...n},this.parent=document.querySelector(e),this.label=this.opts.placeholder?document.querySelector(this.opts.placeholder):null,this.container=this.parent.create("div","pxcalendar");let a=this.container.create("div","pxcalendar__daynames");this.WEEKDAY_NAMES.forEach(s=>a.create("div","pxcalendar__daynames__name",s)),this.month=this.container.create("div","pxcalendar__month"),this.render()}async render(){let e=new Date(this.current.getFullYear(),this.current.getMonth(),1),n=startOfWeek(e,0),a=[];for(let s=0;s<42;s++){let r=addDays(n,s),i=r.getMonth()!==this.current.getMonth(),c=ymd(r),h=c===ymd(new Date),d=this.events.has(c),l=create("div","pxcalendar__month__day",`<span>${r.getDate()}</span>`);i&&l.classList.add("outside"),d&&l.classList.add("has-event"),h&&l.classList.add("today"),d&&this.opts.onRenderDate&&this.opts.onRenderDate(c,l),d&&this.opts.onClickDate&&l.addEventListener("click",()=>this.opts.onClickDate(c,l)),a.push(l)}this.month.replaceChildren(...a),this.label&&(this.label.innerText=`${this.MONTH_NAMES[this.current.getMonth()]} ${this.current.getFullYear()}`)}async addEvents(e){this.events=new Set([...this.events,...e]),this.render()}async next(){this.current=new Date(this.current.getFullYear(),this.current.getMonth()+1,1),this.render()}async previous(){this.current=new Date(this.current.getFullYear(),this.current.getMonth()-1,1),this.render()}};var y=6,_=12,p="America/Toronto";window.Quebec={secrets:null,events:null,modal:null,calendar:null,prec:null,suiv:null,unPays:async function(){await Promise.all([this.initCalendar(),loadJsonProperties(this,{secrets:"bt1oh97j7X.json"})]),this.modal=new m({onlyBgClick:!0}),this.loadGoogleCalendar()},initCalendar:async function(){this.calendar=new u(".calendrier__container",{placeholder:".calendrier__pagination__cour",onRenderDate:(t,e)=>this.renderEvent(t,e),onClickDate:(t,e)=>this.clickEventDay(t,e)}),document.querySelector(".calendrier__pagination__prec > span").addEventListener("click",t=>this.calendar.previous()),document.querySelector(".calendrier__pagination__suiv > span").addEventListener("click",t=>this.calendar.next())},loadGoogleCalendar:async function(){this.events=await this.queryGoogleCalendar();let t=new Set(this.events.map(e=>{let n=new Date(e.start),a=new Date(n.getFullYear(),n.getMonth(),n.getDate());return ymd(a)}));this.calendar.addEvents(t)},queryGoogleCalendar:async function(){let{timeMin:t,timeMax:e}=this.getRangeBounds(),n=new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(this.secrets.CALENDAR_ID)}/events`);n.searchParams.set("key",this.secrets.GOOGLE_API_KEY),n.searchParams.set("supportsAttachments","true"),n.searchParams.set("singleEvents","true"),n.searchParams.set("orderBy","startTime"),n.searchParams.set("timeMin",t),n.searchParams.set("timeMax",e),n.searchParams.set("timeZone",p);let a=await fetch(n.toString());if(!a.ok)throw new Error("Erreur API Google Calendar");let s=await a.json();return localStorage.setItem("lastItems",JSON.stringify(s.items??[])),this.mapGCalEvents(s.items??[])},getRangeBounds:function(){let t=new Date,e=new Date(t),n=new Date(t);return e.setMonth(e.getMonth()-y),n.setMonth(n.getMonth()+_),{timeMin:e.toISOString(),timeMax:n.toISOString()}},mapGCalEvents:function(t){return t.filter(e=>e.status!=="cancelled").map(e=>{let n=!!(e.start&&e.start.date),a=n?fmtDate(new Date(e.start.date)):isoLocal(e.start.dateTime||e.start),s=n?fmtDate(new Date(e.end.date)):isoLocal(e.end.dateTime||e.end),{html:r,firstImage:i}=this.replaceImageLinks(e.description||"");return{id:e.id,title:e.summary||"(Sans titre)",start:a,end:s,location:e.location||null,raw:{htmlLink:e.htmlLink},description:r,image:i}})},replaceImageLinks:function(t){let e=/<a\s+href="([^"]+\.(?:jpg|jpeg|png|webp|gif|svg))"[^>]*>(.*?)<\/a>/gi,n=null;return{html:t.replace(e,(s,r,i)=>(n||(n=r),`<img src="${r}" alt="${escapeForAttr(i)}">`)),firstImage:n}},getEventsByDate:function(t){return this.events.filter(e=>{let n=inTZ(e.start,p),a=inTZ(new Date(new Date(e.end)-1),p);return n<=t&&t<=a})},renderEvent:async function(t,e){let n=this.getEventsByDate(t),a=e.create("div","pxcalendar__month__day__bgimg");n[0].image&&a.style.setProperty("--image-1",`url(${n[0].image})`),n.length>1&&n[1].image&&a.style.setProperty("--image-2",`url(${n[1].image})`)},clickEventDay:async function(t,e){let n=create("div","modal-events"),a=n.create("div","modal-events__placeholder"),s=a.create("div","modal-events__placeholder__close"),r=a.create("div","modal-events__placeholder__date"),i=a.create("div","modal-events__placeholder__events"),h=this.getEventsByDate(t).map(g=>this.renderEventDetails(g)),d=new Date(`${t}T00:00:00`),l={weekday:"long",day:"numeric",month:"long",timeZone:"America/Toronto"},f=new Intl.DateTimeFormat("fr-CA",l).format(d).replace(/^(\w+)/,"$1 le");r.innerHTML=f,s.title="Fermer",s.addEventListener("click",g=>this.modal.hide()),i.append(...h),this.modal.show(n)},renderEventDetails:function(t){let e=create("div","modal-events__placeholder__events__event");return e.innerHTML=t.description,e}};})();
